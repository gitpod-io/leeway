# SBOM and CVE Scanning: Developer Documentation

This document provides technical details for developers who want to extend or modify the SBOM generation and CVE scanning functionality in Leeway.

## Architecture Overview

The SBOM and CVE scanning functionality is implemented as a set of Go packages and integrated into the Leeway build process. The main components are:

1. **SBOM Generation**: Implemented in `pkg/leeway/sbom/sbom.go`
2. **CVE Scanning**: Implemented in `pkg/leeway/sbom/cve.go`
3. **Configuration**: Implemented in `pkg/leeway/sbom/config.go`
4. **Build Integration**: Implemented in `pkg/leeway/sbom/integration.go`
5. **Docker Utilities**: Implemented in `pkg/leeway/docker_utils.go`
6. **Command-Line Interface**: Implemented in `cmd/sbom.go`

## Package Structure

```
pkg/leeway/sbom/
  ├── sbom.go       # SBOM generation core functionality
  ├── cve.go        # CVE scanning functionality
  ├── config.go     # Configuration types and defaults
  └── integration.go # Integration with Leeway build process

pkg/leeway/
  └── docker_utils.go # Docker image extraction utilities

cmd/
  └── sbom.go       # Command-line interface for SBOM and CVE commands
```

## Core Components

### SBOM Generation

The SBOM generation functionality is implemented in `pkg/leeway/sbom/sbom.go`. The main functions are:

- `GenerateSBOM`: Creates an SBOM for a package
- `WriteSBOMToFile`: Writes an SBOM to a file in the specified format
- `MergeSBOMs`: Merges multiple SBOMs into a single SBOM

Package-type specific SBOM generation is implemented in:

- `generateDockerSBOM`: Generates an SBOM for a Docker package
- `generateGoSBOM`: Generates an SBOM for a Go package
- `generateYarnSBOM`: Generates an SBOM for a Yarn package
- `generateGenericSBOM`: Generates an SBOM for a Generic package

### CVE Scanning

The CVE scanning functionality is implemented in `pkg/leeway/sbom/cve.go`. The main functions are:

- `ScanForVulnerabilities`: Scans an SBOM for vulnerabilities
- `isIgnored`: Checks if a vulnerability is ignored
- `HasFailureLevelVulnerabilities`: Checks if a report has vulnerabilities with specified severity levels

### Configuration

The configuration types and defaults are defined in `pkg/leeway/sbom/config.go`:

- `SBOMOptions`: Configuration for SBOM generation
- `CVEOptions`: Configuration for CVE scanning
- `IgnoreRule`: Configuration for ignoring specific vulnerabilities
- `ScanMetadata`: Metadata about a CVE scan

### Build Integration

The integration with the Leeway build process is implemented in `pkg/leeway/sbom/integration.go`:

- `GenerateSBOMForPackage`: Generates an SBOM for a package during the build process
- `ScanPackageForVulnerabilities`: Scans a package for vulnerabilities during the build process
- `ReadIgnoreRulesFromFile`: Reads ignore rules from a YAML file

### Docker Utilities

The Docker utilities are implemented in `pkg/leeway/docker_utils.go`:

- `ExtractImageWithOCILibs`: Extracts a Docker image to a directory
- `createDockerMetadataFiles`: Creates metadata files for a Docker image

## Extending the Functionality

### Adding Support for a New Package Type

To add support for a new package type, you need to:

1. Add a new function in `pkg/leeway/sbom/sbom.go` to generate an SBOM for the new package type
2. Update the `GenerateSBOM` function to call your new function for the new package type

Example:

```go
// generateNewPackageTypeSBOM generates an SBOM for a NewPackageType package
func generateNewPackageTypeSBOM(p *leeway.Package, buildDir string) (*sbom.SBOM, error) {
    // Implementation goes here
}

// Update GenerateSBOM to call your new function
func GenerateSBOM(p *leeway.Package, buildDir string, options *SBOMOptions) (*sbom.SBOM, error) {
    // ...
    switch p.Type {
    case leeway.DockerPackage:
        sbomDoc, err = generateDockerSBOM(p, buildDir)
    case leeway.GoPackage:
        sbomDoc, err = generateGoSBOM(p, buildDir)
    case leeway.YarnPackage:
        sbomDoc, err = generateYarnSBOM(p, buildDir)
    case leeway.GenericPackage:
        sbomDoc, err = generateGenericSBOM(p, buildDir)
    case leeway.NewPackageType:
        sbomDoc, err = generateNewPackageTypeSBOM(p, buildDir)
    default:
        return nil, xerrors.Errorf("unsupported package type for SBOM generation: %s", p.Type)
    }
    // ...
}
```

### Adding Support for a New SBOM Format

To add support for a new SBOM format, you need to:

1. Update the `WriteSBOMToFile` function in `pkg/leeway/sbom/sbom.go` to support the new format
2. Update the command-line flags in `cmd/sbom.go` to include the new format

Example:

```go
// Update WriteSBOMToFile to support the new format
func WriteSBOMToFile(sbomDoc *sbom.SBOM, outputPath, formatStr string) error {
    // ...
    switch strings.ToLower(formatStr) {
    case "cyclonedx", "cyclonedxjson":
        encoder = cyclonedxjson.NewEncoder()
    case "spdx", "spdxjson":
        encoder = spdxjson.NewEncoder()
    case "newformat":
        encoder = newformat.NewEncoder()
    default:
        return xerrors.Errorf("unsupported SBOM format: %s", formatStr)
    }
    // ...
}
```

### Adding New Configuration Options

To add new configuration options, you need to:

1. Update the appropriate configuration struct in `pkg/leeway/sbom/config.go`
2. Update the default configuration provider function
3. Update the command-line flags in `cmd/sbom.go`

Example:

```go
// Update SBOMOptions to add a new option
type SBOMOptions struct {
    // ...
    NewOption string
}

// Update DefaultSBOMOptions to set a default for the new option
func DefaultSBOMOptions() *SBOMOptions {
    return &SBOMOptions{
        Format: "cyclonedx",
        NewOption: "default",
    }
}
```

### Modifying the Build Process Integration

To modify how SBOM generation and CVE scanning are integrated into the build process, you need to update the `pkg/leeway/build.go` file:

```go
// Update the build function to modify the SBOM and CVE scanning integration
func (p *Package) build(buildctx *buildContext) error {
    // ...
    
    // Generate SBOM if enabled
    if buildctx.GenerateSBOM {
        // Your modifications here
    }

    // Scan for vulnerabilities if enabled
    if buildctx.ScanCVE {
        // Your modifications here
    }

    // ...
}
```

## Dependencies

The SBOM and CVE scanning functionality depends on the following external packages:

- `github.com/anchore/syft`: For SBOM generation
- `github.com/anchore/grype`: For vulnerability scanning
- `github.com/containerd/containerd`: For Docker image handling
- `github.com/opencontainers/go-digest`: For OCI support
- `github.com/opencontainers/image-spec`: For OCI support

## Testing

The SBOM and CVE scanning functionality can be tested using the following approaches:

### Unit Tests

Unit tests for the SBOM and CVE scanning functionality should be added to:

- `pkg/leeway/sbom/sbom_test.go`
- `pkg/leeway/sbom/cve_test.go`
- `pkg/leeway/sbom/config_test.go`
- `pkg/leeway/sbom/integration_test.go`

### Integration Tests

Integration tests should test the end-to-end functionality, including:

- SBOM generation for different package types
- CVE scanning with different configuration options
- Build process integration

### Manual Testing

Manual testing should include:

- Testing with real Docker images
- Testing with real Go and Yarn packages
- Testing with various ignore rule configurations

## Performance Considerations

The SBOM generation and CVE scanning functionality can be resource-intensive, especially for large packages. Consider the following performance optimizations:

- Cache vulnerability database updates
- Implement parallel scanning of multiple packages
- Optimize Docker image extraction

## Security Considerations

When extending or modifying the SBOM and CVE scanning functionality, consider the following security aspects:

- Ensure that ignore rules are properly validated
- Implement proper error handling for all external inputs
- Consider the security implications of any new features or modifications

## Future Enhancements

Potential future enhancements to the SBOM and CVE scanning functionality include:

- License scanning
- Misconfiguration detection
- Automated remediation suggestions
- Integration with security dashboards
- Support for additional SBOM formats
- Support for additional package types
